Readable Code

※基本スタンス
→他人が再利用する。

良いコードとは：
　「読みやすい」コードを書くことは、「理解しやすい」コードを書くことであり、そ の結果として「優れた」コードにつながるという信念も素晴らしい。

4つカテゴリ
第Ⅰ部　
　面上の改善 名前・コメント・見た目のようなコード全体に適用できる簡単なヒント 
第Ⅱ部
　ループとロジックの単純化 プログラムのループ・ロジック・変数などを改善して理解しやすくする方法
 第Ⅲ部
　コードの再構成 巨大なコードブロックを再構成して問題を関数のレベルに分解する方法 

第Ⅳ部
　選抜テーマ 「理解しやすさ」をテストや大きなデータ構造に適用する方法

1章：理解しやすいコード
第Ⅰ部　表面上の改善（すべての行に影響する）
鍵となる考え コードは理解しやすくなければいけない。
読みやすさの基本定理
鍵となる考え コードは他の人が最短時間で理解できるように書かなければいけない。
ex. 行数を抑えたい余り、条件が2つ以上となっている論理が複雑な式。否定形を使う。
コードは短くしたほうがいい。だけど、「理解するまでにかかる時間」を短くする ほうが大切だ。（引用p.25）

2章：名前に情報を詰め込む
鍵となる考え 名前に情報を詰め込む。
・明確な単語を選ぶ
ex.get()は明確な動作をイメージさせない
→類義語を探す（カラフルなやつ）
鍵となる考え 気取った言い回しよりも明確で正確なほうがいい。
・汎用的な名前を避ける
いい名前というのは、変数の目的や値を表すものだ。（引用p.34）
ex.tmpは語意から、一時的に利用するものという理解が共有されている。
ループイテレータ：i・j・k・iterをよく使う。
イテレータが複数あるときには、インデックスに明確な名前をつける（引用p.36）
ex. i・j・k ではなく、説明的な名前（club_i・members_i・users_i）にする（引用p.36）
アドバイス tmp・it・retval のような汎用的な名前を使うときは、それ相応の理由を用意しよう。(引用p.36)
・抽象的な名前よりも、具体的な名前を使う
ex. DISALLOW_EVIL_CONSTRUCTORS→DISALLOW_COPY_AND_ASSIGN（許可していないものを明確にするほうが大切）
ex. --run_locally　→　--extra_logging（環境名が入っているのがわかりにくい。直接的で、明確な表現に治す。）
・名前に情報を追加する
変数名に単位を入れるex. start_ms, delay_secs, size_mb, max_kbps, degrees_cw
その他の重要な属性を追加する
ex1. Url, MessageBody　→　untrustedUrl, unsafeMessageBody, trustedUrl, SafeMessageBody
ex2.password→plaintext_password(後に暗号化が必要), comment → unescaped_comment(後にエスケープが必要), html→html_utf8(utf8に変換した), data → data_urlenc(dataをエンコーディングした)
 ・名前の長さを決める
いい名前を選ぶときには、「長い名前を避ける」という暗黙的な制約がある。（引用p.43）
識別子の「スコープ」（その名前が「見える」コードの行数）が小さければ、多 くの情報を詰め込む必要はない。識別子のスコープが大きければ、名前に十分な情報を詰め込んで明確にする必要が ある（引用p.44）
長い名前を入力する際には、単語補完機能を使おう
頭文字と省略形はプロジェクト固有のものでないかを気を使う
ex. evalution → eval, string → str, BEManager → 
不要な単語を削る
ex. ConvertToString() → ToString(), DoserveLoop() → ServeLoop()
・名前のフォーマットで情報を伝える（大文字やアンダースコアに意味を含める）
アンダースコア・ダッシュ・大文字を使って、名前に情報を詰め込むこともでき る。（引用p.46）
ex.クラス名はCamelCaseで、変数名はlower_name(小文字をアンダースコアで区切ったもの), メンバ変数かローカル変数か
-----この部分補足必要------
その他のフォーマット規約
ex. 「コンストラクタ」は大文字で始め、通常の関数は小文字で始める
ex. 変数名の頭に$をつける
ex. idの区切り文字にはアンダースコア、classの区切り文字にはハイフンを使う

3章：誤解されない名前
鍵となる考え 名前が「他の意味と間違えられることはないだろうか？」と何度も自問自答する。
ex. 「選択する」：filter() → select(), Clip(text,length) → Truncate(text, max_chars)
限界値を含めるときはminとmaxを使う
ex. CART_TOO_BIG_LIMIT → MAX_ITEMS_IN_CART（限界値の取り扱いを明確にする）
範囲を指定するときはfirstとlastを使う（終端を範囲に含める際にはそれを明確に）
ex. print integer_range(start=2, stop=4)→print integer_range(first=2, last=4)
包含/ 排他的範囲にはbeginとendを使う
ex. printEventsInRange(“OCT 16 12:00am”, “OCT 17 12:00am”)
ブール値の名前
ブール値の変数やブール値を返す関数の名前を選ぶときには、true と false の意 味を明確にしなければいけない。（引用p.54）
ex. bool read_password = true; → bool need_password, user_is_authenticated = true;
※名前を否定形にするのは避ける。肯定形にしたほうが声に出して読みやすい
ユーザーの期待に合わせる
ex. get*()
ex. list::size()
それぞれに軽量なメソッドが期待されている
-----この部分理解不十分------
複数の名前を検討する
ex. the_other_experiment_id_I_want_to_reuse （再利用したい実験の ID）の名前
→inherit（継承）が最適

4章：美しさ（と優れた設計の両立を目指す）
コードを読みやすくする、余白・配置・順序の3つの原則（引用p.65）
読み手が慣れているパターンと一貫性のあるレイアウトを使う。
似ているコードは似ているように見せる
関連するコードをまとめてブロックにする
なぜ美しさが大切なのか。
先頭を揃える、余白の数を統一。見た目が美しいほうが誰しもが使いやすいから。
一貫性のある簡潔な改行位置
※縦に長くなりすぎ内容にする。
※同じコメントを繰り返す場合には、最上部にコメント行として移動させる
メソッドを使った整列
ex. テストコードなど、見せる必要が無いものは、関数にして隠す。テストが4つ行われているといった事実を記載する
→重複を排除したことで、コードが簡潔になった。コードの類似度が上昇し、読みやすくなった。テストの追加が簡単になった。
縦の線を真っ直ぐにする
列を「整列」させれば、コードが読みやすくなることがある。（引用p.69）
→スペルミスに気づきやすくなる
一貫性と意味のある並び
　どの並び順を選ぶにしても、一連のコードでは同じ並び順を使うべきだ。（引用p.70）
ex. htmlフォームのinputフィールドと同じ並びにする。「最重要」なものから重要度別に並べる。アルファベット順に並べる。
宣言をブロックにまとめる
論理的なグループに分けてあげるとよい。（引用p.50）
コードを「段落」に分割する
処理の内容に応じて、ステップごとに分割し、コメントを添える。
個人的な好みと一貫性
ex.以下２つのスタイルを混ぜてはいけない。
class Logger {
	・・・
};
→
class Logger
{
	・・・
};

鍵となる考え 一貫性のあるスタイルは「正しい」スタイルよりも大切だ（引用p.74）



5章：コメントすべきことを知る
鍵となる考え コメントの目的は、書き手の意図を読み手に知らせることである。(引用p.77)
コメントするべきでは「ない」こと
鍵となる考え コードからすぐにわかることをコメントに書かない。
コードを理解するよりも、コメントを読んだほうが 早く理解できる（引用p.79）
コメントのためのコメントをしない
コメントをつけたければ、もっと大切なことを説明したほうがいい。（引用p.80）
ひどい名前はコメントを付けずに名前を変える
優れたコード　＞　ひどいコード　＋　優れたコメント
自らの考えを記録する
作品がどのように作られたかを記入
コードの欠陥にコメントを付ける（コードの品質や状態、改善の方向を示せる）
記法：典型的な意味
TODO：後で手を付ける
FIXME：既知の不具合があるレコード
HACK：余りきれいじゃない解決策
XXX：危険！大きな問題がある
定数にコメントをつける
定数の値を決めたときに頭のなかで考えていたことを記録することが大切なのだ。（引用p.83）
読み手の立場になって考える
-----この部分理解不十分------
「全体像」へのコメント
コードを読むだけではわからない、短い適切な文章でかまわない。何も無いよりはまし。
要約コメント
ex. ユーザのロックを獲得する, ユーザの情報をDBから読み込む, 情報をファイルに書き出す, このユーザのロックを開放する
ライダーズブロックを乗り越える
※行き詰まってしまって、文章がかけないこと
→自分の考えていることをとりあえず書き出してみる
コメントを書く作業は、3 つの簡単な手順に分解できる（引用p.90）
	頭の中にあるコメントをとにかく書き出す
	コメントをよんで（どちらかといえば）改善が必要なものを見つける
	改善する

6章：コメントは正確で簡潔に
鍵となる考え コメントは領域に対する情報の比率が高くなければいけない。
コメントを簡潔にしておく
曖昧な代名詞を避ける
ex. 「それ」を明確にする
歯切れの悪い文章を磨く
ex. 既存のURLかによって優先度を変える　→　新規のURLの優先度を高くする
関数の動作を正確に記述する
ex. このファイルに含まれる行数を返す　→　このファイルに含まれる改行文字（’\n’）を数える
入出力のコーナーケースに実例を使う
ex. 関数の機能を見せることによって、示している
コードの意図を書く
ex. listを逆順にイテレートする　→　値段の高い順に表示する
「名前付き引数」コメント
情報密度の高い言葉を使う
ex. 「Avenue」を「Ave.」に整形する　→　所在地を正規化する

第Ⅱ部　ループとロジックの単純化
7章：制御フローを読みやすくする
鍵となる考え 条件やループなどの制御フローはできるだけ「自然」にする。コードの読み手が立ち止まっ たり読み返したりしないように書く
条件式の引数の並び順
左側：「調査対象」の式。変化する。右側：「比較対象」の式。余り変化しない。
※SVCの考え方
ex. if (10<= length) → if(length >= 10), while(bytes_expected > bytes_received) → while (bytes_received < bytes_expected)
if/else ブロックの並び順
条件は否定形よりも肯定形を使う。例えば、if (!debug) ではなく、if (debug) を使う。単純な条件を先に書く。if と else が同じ画面に表示されるので見やすい。関心を引く条件や目立つ条件を先に書く。（引用p.107）。一般的には、肯定形・単純・目立つも のを先に処理する。（引用p.118）
ブロック内で、注意を引く（本流な）処理を先に書く
三項演算子
ex. [C] time_str += (hour >= 12) ? “pm” : “am”;→if文使ったほうがいいかも
鍵となる考え 行数を短くするよりも、他の人が理解するのにかかる時間を短くする
アドバイス 基本的には if/else を使おう。三項演算子はそれによって簡潔になるときにだけ使おう。
do/whileループを避ける
do/whileループは再実行の条件が下にあってコードを2回読むことになる。whileループにすればコードを読む前に繰り返し条件がわかるので読みやすくなる。
do/while ループは、while ループで書き直せることが多い（引用p.111）
関数から早く返す
-----この部分理解不十分-----（ガード節）
悪名高き goto
C言語にある文法。関数の最下部に置いたexitと一緒に使う。
ネストを浅くする
鍵となる考え 変更するときにはコードを新鮮な目で見る。一歩下がって全体を見る
if文のネスト→早めにreturnして、ネストを削除する。
ループ内部のネストも削除する
ループ内部のネスト→continueを使う
※ループは一つのみにして、continueに「この項目は飛ばす」という意味付けをする
深いネストを避けるには「直線的」なコードを選択する（p.118）

8章：巨大な式を分割する
鍵となる考え 巨大な式は飲み込みやすい大きさに分割する。
説明変数（式を簡単に分割するには、式を表す変数を使う）
ex. username = line.split(“:”)[0].sprit()
巨大な式を分割できる。簡潔な名前で式を説明することで、コードを文章化できる。コードの主要な「概念」を読み手が認識しやすくなる。（引用p.129）
要約変数（変数が多くなる場合、管理を簡単にするためにつかう）
if(request.user.id == document.owner_id)
→final boolean user_owns_document = (request.user.id == document.owner_id)
if (user_owns_document){
・・・
}
if(!user_owns_document){
・・・
}
ド・モルガンの法則を使う
ex. !(file_exists && !is_protected) → !file_exists || is_protected
短絡評価の悪用
鍵となる考え 「頭がいい」コードに気を付ける。あとで他の人がコードを読むときにわかりにくくなる。
例：複雑なロジックと格闘する
-----この部分理解保留----
巨大な文を分割する
変数の定義が多い場合にはそれらを要約変数として関数の最上部に抽出する
式を簡潔にするもう一つの創造的な方法

9章：変数と読みやすさ
変数を適当に使うとプログラムが理解しにくくなる。変数が多いと変数を追跡するのが難しくなる。 2. 変数のスコープが大きいとスコープを把握する時間が長くなる。 3. 変数が頻繁に変更されると現在の値を把握するのが難しくなる。（引用p.112）
変数を削除する
（役に立たない一時変数）
ex.(nowがなくても楽に理解できる)
now = datetime.datetime.now()
 root_message.last_view_time = now
（中間結果を削除する）
関数から早めに返す（return）事により、不要な変数を削ることができる
（制御フロー関数を削除する）
変数のスコープを縮める
　「グローバル変数は避ける」というアドバイスは、誰もが一度は耳にしたことがあ るはずだ。グローバル変数に限らず、すべての変数の「スコープを縮める」のはいい考えだ。（引用p.136）
鍵となる考え 変数のことが見えるコード行数をできるだけ減らす。
JavaScriptで「プライベート」変数を作る。関数内で定義した変数はプライベート変数となり、関数内でしか利用できない。
JavaScriptはvar x = 1はプライベートだが、x = 1とすると、グローバルスコープに入る
PythonとJavaScriptのネストしないスコープ
-----理解不足-----
定義の位置を下げる
最初からすべての変数を知る必要はないのだから、変数の定義は変数を使う直前に 移動すればいい。（引用p.143）
変数は一度だけ書き込む
鍵となる考え 変数を操作する場所が増えると、現在値の判断が難しくなる。
ex. constとか、イミュータブルにする方法を使う
最後の例
-----コーディング添削練習-----
まとめ


第Ⅲ部　コードの再構成
10章：無関係の下位問題を抽出する（プロジェクト固有のコードから汎用コードを分離すると いうことだ。ほとんどのコードは汎用化できる。）（引用p.162）
エンジニアリングとは、大きな問題を小さな問題に分割して、それぞれの解決策を 組み立てることに他ならない。その関数に無関係の問題を積極的に見つけて抽出することが重要。
入門的な例：findClosestLocation()
ポイント:それぞれの関数は将来的に再利用可能で、完全に自己完結していること。
純粋なユーティリティコード
基本的なタスクは組み込みライブラリで実装されているのでそれを用いる
その他の汎用コード
汎用コードをたくさん作る
→いずれも基本的で広く適用可能なので、複数のプロジェクトで再利用できる。　汎用コードは素晴らしい。プロジェクトから完全に切り離されているからだ。（引用p.156）
プロジェクトに特化した機能
既存のインタフェースを簡潔にする
必要に応じてインターフェースを整える
ex. 暗号化関数は別にその機能だけを独立させる
やりすぎ→細かくしすぎると（小さな関数を作りすぎると）逆に読みにくいので注意

11章：一度に1つのことを
鍵となる考え コードは 1 つずつタスクを行うようにしなければいけない
ex. コードが行っている「タスク」すb手を列挙する→タスクをできるだけ異なる関数に分割する
タスクは分割できる
「一度に1つのタスク」を適用する
関数内でも処理の目的によって、区分する（関数に分割→段落に分割）


12章：コードに思いを込める
おばあちゃんがわかるように説明できなければ、本当に理解したとは言えない。 ̶̶アルバート・アインシュタイン
コードをより明確にする簡単な手順
1. コードの動作を簡単な言葉で同僚にもわかるように説明する。 2. その説明のなかで使っているキーワードやフレーズに注目する。 3. その説明に合わせてコードを書く。
ロジックを明確に説明する
ex. if文の否定条件はなるべく使わない
ライブラリを知る
なるべくライブラリを使って実装する
この手法を大きな問題に適用する
-----実際の例でコードをみる-----




13章：短いコードを書く
自分で書いたコードであれば、すべての行をテストして保守し なければいけない。ライブラリの再利用や機能の削除をすることで、時間を節約した り、コードを簡潔に維持したりできる。（引用p.189）
鍵となる考え 最も読みやすいコードは、何も書かれていないコードだ。
その機能の実装について悩まないで--きっと必要ないから
プログラマは将来的に必要となる保守や文書化などの「負担」時間を過小評価する。
汎用的な「ユーティリティ」コードを作って、重複コードを削除する（「10 章　無関係の下位問題を抽出する」参照）。 ● 未使用のコードや無用の機能を削除する（以下のコラムを参照）。 ● プロジェクトをサブプロジェクトに分割する。 ● コードの「重量」を意識する。軽量で機敏にしておく。（引用p.192）
身近なライブラリに親しむ
ここでささやかな提案だ。たまには標準ライブラリのすべての関数・モジュール・ 型の名前を 15 分かけて読んでみよう。ライブラリを全部覚えろと言ってるわけじゃない。どんなことができそうか感じ取 るだけでいい。（引用p.193）
Pythonのリストとセット
ex. リスト内の重複を消すには。。。set関数をつかえばええやん！！
ライブラリの再利用はなぜいいことなのか
　大切なのは、出荷用という言葉だ。成熟したライブラリのコードの裏側には、膨大 な設計・デバッグ・修正・文書・最適化・テストが存在する。時間の節約になるし、書くコードも少なくなる。（引用p.194）
例：コーディングするよりもUnixツールボックスを使う
-----理解不足-----
まとめ
不必要な機能をプロダクトから削除する。過剰な機能は持たせない。 ● 最も簡単に問題を解決できるような要求を考える。 ● 定期的にすべての API を読んで、標準ライブラリに慣れ親しんでおく。




第Ⅳ部　選抜テーマ
14章：テストと読みやすさ
15章：「分/時間カウンタ」を設計・実装する
名前を改善する ex. count()
コメントを改善する MinuteCount(); →現在時刻の分数のカウントを返す。か直近60秒間のカウントを返すのかわからない。
このコードは理解しやすいか
難解なforループや重複コードがあればなるべく避けるか、共有化する
読みやすいバージョン
共通する処理はリファクタリングして統一
パフォーマンスの問題
試案2：ベルトコンベヤー設計
これで終わり？？
簡単な変数の変更はなるべく簡単に対応できるように設計する
-----pythonで実装する------


付録　合わせて読みたい

高品質のコードを書くための書籍
『Code Complete 第 2 版〈上〉〈下〉̶̶完全なプログラミングを目指して』スティー
ブ・マコネル 著、クイープ 訳、日経 BP ソフトプレス
コードの品質などソフトウェアの構築に関するあらゆる側面について、緻密でよ
く調査された学術書。
『リファクタリング̶̶プログラムの体質改善テクニック』マーチン・ファウラー 著、
児玉公信、平澤章、友野晶夫、梅沢真史 訳、ピアソンエデュケーション
漸進的なコードの改善に関する名著。さまざまなリファクタリング手法の詳細な
カタログとコードを破壊せずに変更を加える手順が載っている。
『プログラミング作法』ブライアン・カーニハン、ロブ・パイク 著、福崎俊博 訳、
アスキー
デバッグ・テスト・移植性・パフォーマンスなどのプログラミングに関する話題
と豊富なサンプルコードが載っている。
『達人プログラマー̶̶システム開発の職人から名匠への道』アンドリュー・ハント、
デビッド・トーマス 著、村上雅章 訳、ピアソンエデュケーション
プログラミングやエンジニアリングの優れた原則がたくさん集められていて、短
い考察と一緒に載っている。
『Clean Code̶̶アジャイルソフトウェア達人の技』ロバート・C・マーティン 著、
花井志生 訳、アスキー・メディアワークス
本書と似ている（こちらは Java 専用になっている）けれど、エラー処理や同時
並行性などについても考察されている。

プログラミングに関する書籍
『JavaScript: The Good Parts̶̶「良いパーツ」によるベストプラクティス』ダグラ
ス・クロックフォード 著、水野貴明 訳、オライリー・ジャパン
読みやすさのことを扱っているわけではないけど、ぼくたちと同じ魂が宿ってい
る。JavaScript でエラーの少ないキレイなサブセットを使うという内容だ。
『Effective Java 第 2 版』ジョシュア・ブロック 著、柴田芳樹 訳、ピアソンエデュ
ケーション
Java のプログラムを読みやすくバグの少ないものにできる驚異的な本。Java に
関する本だけど、ここで紹介されている多くの原則があらゆる言語に当てはま
る。非常にオススメ。
『オブジェクト指向における再利用のためのデザインパターン』エリック・ガンマ、
リチャード・ヘルム、ラルフ・ジョンソン、ジョン・ブリシディース 著、本位田真
一、吉田和樹 訳、ソフトバンククリエイティブ
ソフトウェアエンジニアがオブジェクト指向プログラミングについて語る上で共
通言語となる「パターン」の原典。汎用的で便利なソフトウェアパターンを一覧
にしたものであり、これらを使えば、はじめて遭遇する厄介な問題を解決すると
きに陥りそうな罠を回避できる。
『珠玉のプログラミング̶̶本質を見抜いたアルゴリズムとデータ構造』ジョン・ベ
ントリー 著、小林健一郎 訳、ピアソンエデュケーション
実際のソフトウェアの問題に関する本。現実世界の問題を解決する鋭い知見をも
たらしてくれる。
『ハイパフォーマンス Web サイト̶̶高速サイトを実現する 14 のルール』スティー
ブ・サウダーズ 著、武舎広幸、福地太郎、武舎るみ 訳、オライリー・ジャパン
プログラミングの本じゃないけれど、できるだけコードを書かないでウェブサ
イトを最適化する方法を紹介してくれるという点で注目に値する（「13 章 短い
コードを書く」とあわせて読みたい）。

解説
そんな本書の内容を身につけて、自然に読みやすいコードを書けるようになるため
の 3 つのステップを紹介しよう。

実際にやる
	実際にやるとぶつかること
	他の人に読んでもらう
	おさらい
当たり前にする
	既存のコードを読みやすくする前にやること
続ける事が大事
コードで伝える
	読みやすいコードがもっと当たり前で有り続けるために
	コミットメールのススメ
まずはあなたが読む


「自分が書いたコードってどのくらい覚えているんですか？」
「ほとんど覚えていないですよ。」
「直すときどうするんですか？ わからなくなってるじゃないですか。」
「忘れても見たら簡単にわかるように書いておくんですよ。」

	





